---
title: "SDM results"
author: "Victor Cameron"
date: "08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE)
```


```{r dependencies, echo=FALSE}
library(ggplot2)
library(hrbrthemes)
library(ggpubr)
source("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/patch_metrics.R")
source("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/map_GRBI.R")
```

```{r GRBI map, echo=FALSE}
if(!file.exists("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png")){
    source("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/map_GRBI.R")
    
    plot.map(projRaster_path = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/projections_GRBI.RDS", 
             extent = c(xmin = -75, xmax = -64, ymin = 45, ymax = 49.5), 
             file_name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png")   
}
```

```{r extract metrics, echo=FALSE}
# Functions to extract metrics

# # Patch area
extract.patchArea <- function(metrics){
    area <- setNames(data.frame(matrix(ncol = 2, nrow = 0)), c("area", "temp"))
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        for(j in seq_along(metrics[[i]]$patchArea$patch)){
            area <- rbind(area, c(metrics[[i]]$patchArea$area[j], i*0.2-0.2))
        }
    }
    colnames(area) <- c("area", "temp")
    area$temp <- as.factor(area$temp)
    
    return(area)
}

# # Inter patch distance
extract.dist <- function(metrics){
    dist <- setNames(data.frame(matrix(ncol = 2, nrow = 0)), c("dist", "temp"))
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        dij <- metrics[[i]]$d_ij[lower.tri(metrics[[i]]$d_ij, diag = FALSE)]
        temp <- rep(i*0.2-0.2, length(dij))

        dist <- rbind(dist, data.frame(dij, temp))
    }
    colnames(dist) <- c("dist", "temp")
    dist$temp <- as.factor(dist$temp)
    
    return(dist)
}

# # Metapop capacity
extract.capacity <- function(metrics){
    capacity <- c()
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        capacity[i] <- metrics[[i]]$capacity
    }
    
    return(capacity)
}

# # Total area (habitat availability/quantity)
extract.area <- function(metrics){
    area <- c()
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        area[i] <- metrics[[i]]$totalArea
    }
    
    return(area)
}
```

```{r cc, echo=FALSE}
cc <- seq(0,4,le=21)
```

```{r full distribution, echo=FALSE}
# 1 - Full distribution -----------------------------------


# Data
metrics_QC <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_QC.RDS")

# Extract metrics
area_QC <- extract.patchArea(metrics_QC)
area_QC_sub <- area_QC[area_QC$temp %in% seq(0,4,by=2),]

dist_QC <- extract.dist(metrics_QC)
dist_QC_sub <- dist_QC[dist_QC$temp %in% seq(0,4,by=2),]

cap_QC <- extract.capacity(metrics_QC)
cap_QC <- data.frame(capacity=cap_QC, temp=cc[seq_along(cap_QC)])

totalArea=extract.area(metrics_QC)
totalArea_QC <- data.frame(totalArea=totalArea, temp=cc[seq_along(totalArea)])
```

```{r EasternTownships, echo=FALSE}
# 2 - EasternTownships ------------------------------------


# Data
metrics_ET <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_ET.RDS")

# Extract metrics
area_ET <- extract.patchArea(metrics_ET)
area_ET_sub <- area_ET[area_ET$temp %in% seq(0,4,by=2),]

dist_ET <- extract.dist(metrics_ET)
dist_ET_sub <- dist_ET[dist_ET$temp %in% seq(0,4,by=2),]

cap_ET <- extract.capacity(metrics_ET)
cap_ET <- data.frame(capacity=cap_ET, temp=cc[seq_along(cap_ET)])

totalArea=extract.area(metrics_ET)
totalArea_ET <- data.frame(totalArea=totalArea, temp=cc[seq_along(totalArea)])
```

```{r forêt Montmorency, echo=FALSE}
# 3 -Forêt Montmorency ------------------------------


# Data
metrics_M <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_M.RDS")

# Extract metrics
area_M <- extract.patchArea(metrics_M)
area_M_sub <- area_M[area_M$temp %in% seq(0,4,by=2),]

dist_M <- extract.dist(metrics_M)
dist_M_sub <- dist_M[dist_M$temp %in% seq(0,4,by=2),]

cap_M <- extract.capacity(metrics_M)
cap_M <- data.frame(capacity=cap_M, temp=cc[seq_along(cap_M)])

totalArea=extract.area(metrics_M)
totalArea_M <- data.frame(totalArea=totalArea, temp=cc[seq_along(totalArea)])
```


## Maps

<center>
![](/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/GRBI.gif)

<!-- ![](/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png) -->
</center>

```{r 4 range map, fig.align='center', out.width = "100%", out.height = "200%", echo=FALSE}
plot.map3()
```

## Results panel

```{r 4 panel area, fig.align='center', out.width = "100%", echo=FALSE}
library(dplyr)
# 1. Combine all data
area_dupl <- bind_rows(area_QC, area_M, area_ET, .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))
dist_dupl <- bind_rows(dist_QC, dist_M, dist_ET, .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))
totalArea_dupl <- bind_rows(totalArea_QC, totalArea_M, totalArea_ET, .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))

# Count patch number per region and temperature step
dat_total <- group_by(area_dupl, id, temp) %>%
           summarise(n = n())
# Plot number of patches by region and temperature warming step
coeff <- 40
cols <- c("blue4", "green4", "brown3")
p_total <- ggplot(dat_total, aes(x=temp, y=n, group=id, color=id)) +
           scale_color_manual(values=cols) +
           geom_line(data = subset(dat_total, id %in% c("QC","M"))) +
           geom_line(data=subset(dat_total, id=="ET"), aes(y=n*coeff)) +
           #scale_linetype_manual(values=c("solid", "twodash", "dotted")) +
           scale_x_discrete(name="Temperature warming (°C)", breaks=seq(0,4,0.5)) +
           scale_y_continuous(name="Number of patches \n(Québec & F. Montmorency)", sec.axis = sec_axis(~./coeff, name="Number of patches \n(Eastern Tornships)")) +
           labs(linetype = "Regions") +
           theme_classic() +
           theme(legend.position = c(.95, .95), legend.justification = c("right", "top"), legend.key.size = unit(0.5, 'cm'), legend.text = element_text(size=7), legend.title=element_blank()) 

coeff <- 40
p_area <- ggplot(data=totalArea_dupl, aes(x=temp, y=totalArea, group=id, color=id)) +
          scale_color_manual(values=cols) +
          geom_line(data=subset(totalArea_dupl, id %in% c("QC","M"))) +
          geom_line(data=subset(totalArea_dupl, id=="ET"), aes(y=totalArea*coeff)) +
          scale_x_continuous(name="Temperature warming (°C)") +
          scale_y_continuous(name="Habitat amount \n(Québec, Montmorency; km2)", sec.axis = sec_axis(~./coeff, name="Habitat amount \n(Eastern Townships; km2)")) +
          theme_classic() +
          theme(legend.position = c(.95, .95), legend.justification = c("right", "top"), legend.key.size = unit(0.5, 'cm'), legend.text = element_text(size=7), legend.title=element_blank())

pArea_QC <- ggplot(data=area_dupl[area_dupl$id == "QC" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[3],3)) +
            ggtitle("Québec") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic() +
            theme(legend.position = c(.95, .95), legend.justification = c("right", "top"), legend.key.size = unit(0.3, 'cm'), legend.text = element_text(size=5), legend.title=element_blank())
pArea_M <- ggplot(data=area_dupl[area_dupl$id == "M" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[2],3)) +
            ggtitle("Forêt Montmorency") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic()
pArea_ET <- ggplot(data=area_dupl[area_dupl$id == "ET" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[1],3)) +
            ggtitle("Eastern Townships") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic()
pDist_QC <- ggplot(data=dist_dupl[dist_dupl$id == "QC" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[3],3)) +
            geom_density(aes(linetype=temp), adjust = 8) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()
pDist_M <- ggplot(data=dist_dupl[dist_dupl$id == "M" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[2],3)) +
            geom_density(aes(linetype=temp), adjust = 8) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()
pDist_ET <- ggplot(data=dist_dupl[dist_dupl$id == "ET" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[1],3)) +
            geom_density(aes(linetype=temp), adjust = 5) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()

ggarrange(p_total + rremove("xlab") + rremove("x.text"), p_area + rremove("legend"),
          ggarrange(pArea_QC + rremove("xlab"), pArea_M + rremove("legend") + rremove("y.text") + rremove("ylab"), pArea_ET + rremove("legend") + rremove("y.text") + rremove("ylab") + rremove("xlab"), ncol = 3, align = "h", widths = c(1.2, 1, 1)),
          ggarrange(pDist_QC + rremove("legend") + rremove("xlab"), pDist_M + rremove("legend") + rremove("y.text") + rremove("ylab"), pDist_ET + rremove("legend") + rremove("y.text") + rremove("ylab") + rremove("xlab"), ncol = 3, align = "h", widths = c(1.2, 1, 1)),
          nrow = 4, heights = c(1.5, 1.5, 1.2, 1), align = "v")
```


Results at the scale of Québec as well as for the Forêt Montmorency present expansion of habitat amount hiding the simulataneous habitat patches loss and fragmentation. In the Eastern Townships, effects of habitat patch loss and contraction are clearly observable.

The figure presents counter intuitive results: a warming of the climate leads to i) habitat patches loss, ii) an increase in total habitat amount and iii) little change in density distribution of habitat patch area. **Only the loss of small patches balanced by the fragmentation of large patches and the increase in size of few patches may explain the constant density distribution**.

These confounding results are the result of the habitat expansion to previously unsuitable habitat (colonization) hiding the effects of habitat patch contraction, extinction and fragmentation.

## Metapop effect

Habitat amount vs. landscape connectivity (capacity)

```{r compute capacity, echo=FALSE, eval=FALSE}
# Function to compute and save metapop capacities for different alpha values
compute.capacity <- function(metrics, cc, totalArea, file.name, alpha = c(1, 5, 50, 200, 500)){
    capacity <- data.frame(temp = cc, 
                                weight = c(1000,rep(1,length(cc)-1))) # weights given to force all lines at single origin
    # # Compute capacity for different alpha values
    for(a in alpha){
        eigen <- as.data.frame(get.capacity(metrics, alpha = 1/a, cc)$eigen)
        names(eigen) <- paste0("eigen", a)
        capacity <- cbind(capacity,eigen)
    }

     # # Save computed capacities
    saveRDS(capacity, file.name)
}

# Compute capacities
compute.capacity(metrics_QC, cc, totalArea_QC, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_QC.RDS")
compute.capacity(metrics_M, cc, totalArea_M, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_M.RDS")
compute.capacity(metrics_ET, cc, totalArea_ET, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_ET.RDS")
```

```{r capacity vs. area, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=FALSE}

# Function to return capacity plot
plot.capacity <- function(metrics, cc, totalArea, file.name, alpha = c(1, 5, 50, 200, 500)){
    
    # Load data
    capacity <- readRDS(file.name)    

    # Cols
    colo <- colorRampPalette(c("grey90", "steelblue4", 
                            "steelblue2", "steelblue1", 
                            "gold", "red1", "red4"))(length(alpha))

    # Base plot
    p_cap <- ggplot(data=totalArea, aes(x=temp, y=totalArea/totalArea[1])) +
                geom_smooth(aes(weight=totalArea_ET$weight), se=FALSE, col = "black", size=0.5) +
                scale_x_continuous(name="Temperature warming (°C)", limits=c(0,4)) +
                scale_y_continuous(name = "") +
                ggtitle("Eastern Townships") +
                theme_classic() +
                theme(axis.text.y = element_blank())

    # Add lines
    p_cap <- p_cap + 
            geom_smooth(data=capacity, aes(y=capacity[,3]/capacity[,3][1], weight=weight), linetype=2, se=FALSE, col = colo[1], size=0.5) +
            geom_smooth(data=capacity, aes(y=capacity[,4]/capacity[,4][1], weight=weight), linetype=2, se=FALSE, col = colo[2], size=0.5) +
            geom_smooth(data=capacity, aes(y=capacity[,5]/capacity[,5][1], weight=weight), linetype=2, se=FALSE, col = colo[3], size=0.5) +
            geom_smooth(data=capacity, aes(y=capacity[,6]/capacity[,6][1], weight=weight), linetype=2, se=FALSE, col = colo[4], size=0.5) +
            geom_smooth(data=capacity, aes(y=capacity[,7]/capacity[,7][1], weight=weight), linetype=2, se=FALSE, col = colo[5], size=0.5) 

    return(p_cap)
}

# 
p_capQC <- plot.capacity(metrics_QC, cc, totalArea_QC, compute.cap = TRUE, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_QC.RDS")
p_capM <- plot.capacity(metrics_M, cc, totalArea_M, compute.cap = TRUE, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_M.RDS")
p_capET <- plot.capacity(metrics_ET, cc, totalArea_ET, file.name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/capacities_ET.RDS")

ggarrange(p_capQC, p_capM, p_capET, ncol = 3)
````

Metapopulation capacities are shown for alpha values of 1, 5, 50, 200, and 500km.
```{r metapop effect, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=TRUE}
capacity <- bind_rows(cap_QC, cap_M, cap_ET, , .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))


group_by(capacity, id, temp) %>%
           ggplot(aes(x=temp, y=capacity, group=id, color=id)) +
           geom_line() +
           scale_color_manual(values=cols) +
           scale_x_continuous(name="Temperature warming (°C)") +
           scale_y_continuous(name = "Metapop capacity") +
           labs(linetype = "Regions") +
           theme_classic()

# QC

totalArea_QC$weight <- c(1000,rep(1,nrow(totalArea_QC)-1))
cap_QC$weight <- c(1000,rep(1,nrow(cap_QC)-1))
pMeta_QC <- ggplot(data=totalArea_QC, aes(x=temp, y=totalArea/totalArea[1])) +
               geom_smooth(aes(weight=totalArea_QC$weight), se=FALSE, col = "black", size=0.5) +
               geom_smooth(data=cap_QC, aes(y=capacity/capacity[1], weight=weight), linetype=2, se=FALSE, col = "black", size=0.5) +
               scale_x_continuous(name="Temperature warming (°C)", limits=c(0,4)) +
               scale_y_continuous(name = "") +
               ggtitle("Québec") +
               theme_classic() +
               theme(axis.text.y = element_blank())

# ET
totalArea_ET$weight <- c(1000,rep(1,nrow(totalArea_ET)-1))
cap_ET$weight <- c(1000,rep(1,nrow(cap_ET)-1))
pMeta_ET <- ggplot(data=totalArea_ET, aes(x=temp, y=totalArea/totalArea[1])) +
               geom_smooth(aes(weight=totalArea_ET$weight), se=FALSE, col = "black", size=0.5) +
               geom_smooth(data=cap_ET, aes(y=capacity/capacity[1], weight=weight), linetype=2, se=FALSE, col = "black", size=0.5) +
               scale_x_continuous(name="Temperature warming (°C)", limits=c(0,4)) +
               scale_y_continuous(name = "") +
               ggtitle("Eastern Townships") +
               theme_classic() +
               theme(axis.text.y = element_blank())

# M
totalArea_M$weight <- c(1000,rep(1,nrow(totalArea_M)-1))
cap_M$weight <- c(1000,rep(1,nrow(cap_M)-1))
pMeta_M <- ggplot(data=totalArea_M, aes(x=temp, y=totalArea/totalArea[1])) +
               geom_smooth(aes(weight=totalArea_M$weight), se=FALSE, col = "black", size=0.5) +
               geom_smooth(data=cap_M, aes(y=capacity/capacity[1], weight=weight), linetype=2, se=FALSE, col = "black", size=0.5) +
               scale_x_continuous(name="Temperature warming (°C)", limits=c(0,4)) +
               scale_y_continuous(name = "") +
               ggtitle("Forêt Montmorency") +
               theme_classic() +
               theme(axis.text.y = element_blank())

ggarrange(pMeta_QC, pMeta_M, pMeta_ET, ncol = 3)
```

## Mismatch

Proportion of suitability of the different habitat types (type of forest cover) is presented for climate warming scenarios.

```{r mismatch, fig.align='center', out.width = "100%", fig.asp = .4, echo=FALSE}
# Data --------------------------------------------------------------------


explana_dat <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/explana_dat.RDS")
SDM <- readRDS( "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/projections_GRBI.RDS")


# Funtion to compute habitat occupancy tables -----------------------------


habOcc.table <- function(explana_dat, SDM, extent = c(xmin = -75, xmax = -64, ymin = 45, ymax = 49.5), RL_cutoff = 0.05){
     # Crop rasters
     e <- raster::extent(extent)
     explana_sub <- raster::crop(explana_dat, e)
     SDM_sub <- raster::crop(SDM, e)

     # Initial distribution of habitats occupied
     t_couv <- table(raster::values(explana_sub[["type_couv"]]))
     t <- table(raster::values(explana_sub[["type_couv"]]), raster::values(SDM_sub[[1]]>=log(RL_cutoff)))
     t_occ <- t[,"TRUE"]/t_couv

     # +2°C habitat distribution occupied by GRBI
     t <- table(raster::values(explana_sub[["type_couv"]]), raster::values(SDM_sub[[11]]>=log(RL_cutoff)))
     t_occ <- rbind(t_occ, t[,"TRUE"]/t_couv)

     # +4°C habitat distribution occupied by GRBI
     if(any(raster::values(SDM_sub[[21]])>=log(RL_cutoff), na.rm = TRUE)){
          t <- table(raster::values(explana_sub[["type_couv"]]), raster::values(SDM_sub[[21]]>=log(RL_cutoff)))
          t_occ <- rbind(t_occ, t[,"TRUE"]/t_couv)
     }
     

     # Rename table
     rownames(t_occ) <- c("0°C", "+2°C", "+4°C")[1:nrow(t_occ)]
     colnames(t_occ) <- c("B", "M", "T")

     # Return
     return(t_occ)
}


# Compute habitat occupancy tables -----------------------------------------

# Québec 
t_GRBI_QC <- habOcc.table(explana_dat, SDM, extent = c(xmin = -75, xmax = -64, ymin = 45, ymax = 49.5), RL_cutoff = 0.05)

# Forêt Montmorency 
t_GRBI_M <- habOcc.table(explana_dat, SDM, extent = c(xmin = -72.2, xmax = -70, ymin = 46.8, ymax = 48.2), RL_cutoff = 0.05)

# Eastern Townships
t_GRBI_ET <- habOcc.table(explana_dat, SDM, extent = c(xmin = -73, xmax = -70, ymin = 45, ymax = 46), RL_cutoff = 0.05)

# Gaspésie
t_GRBI_G <- habOcc.table(explana_dat, SDM, extent = c(xmin = -67.5, xmax = -65, ymin = 48, ymax = 49), RL_cutoff = 0.05)


# Plot --------------------------------------------------------------------

par(mfrow = c(1,4))
barplot(t(t_GRBI_QC), beside = TRUE, legend = TRUE, main = "Québec", ylab = "Proportion of occupied habitats")
barplot(t(t_GRBI_M), beside = TRUE, legend = TRUE, main = "Forêt Montmorency")
barplot(t(t_GRBI_ET), beside = TRUE, legend = TRUE, main = "Eastern Townships")
barplot(t(t_GRBI_G), beside = TRUE, legend = TRUE, main = "Gaspésie")
```

Examination of the mismatch between habitat and species abiotic niche shows an increase at the Québec scale of habitat amount (expansion). That is because newly suitable habitat is added to the distribution. However, the effects of loss and fragmentation of previously suitable habitat is hidden by the new suitable patches.

Mismatch affects not only the proportion of habitat types occupied, but also the change in proportions occupied between habitat types. At the scale of Québec, the change in occupancy is of:
```{r prop change QC, fig.align='center', echo=TRUE}
# Change in habitat occupancy
(t_GRBI_QC[2,]-t_GRBI_QC[1,])/t_GRBI_QC[1,] # 0 to +2
(t_GRBI_QC[3,]-t_GRBI_QC[2,])/t_GRBI_QC[2,] # +2 to +4
```

In Forêt Montmorency:

```{r prop change M, fig.align='center', echo=TRUE}
# Change in habitat occupancy
(t_GRBI_M[2,]-t_GRBI_M[1,])/t_GRBI_M[1,] # 0 to +2
(t_GRBI_M[3,]-t_GRBI_M[2,])/t_GRBI_M[2,] # +2 to +4
```

In the Eastern Townships:

```{r prop change ET, fig.align='center', echo=TRUE}
# Change in habitat occupancy
(t_GRBI_ET[2,]-t_GRBI_ET[1,])/t_GRBI_ET[1,] # 0 to +2
```

# Preliminary exploration of visualizations

Scripts are not run in order to save processing time

## Patch area

```{r area subfigures, echo=FALSE, eval=FALSE}
# Patch area for full QC
# # Stacked density chart
p1_QC <- ggplot(data=area_QC_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p2_QC <- ggplot(data=area_QC_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# patch area for foret montmorency
# # Stacked density chart
p1_M <- ggplot(data=area_M_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
        ggtitle("Forêt Montmorency") +
        geom_density(position="fill", adjust = 3) +
        scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_M_sub$temp))]) +
        theme_minimal()
# # Multi density chart
p2_M <- ggplot(data=area_M_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
        ggtitle("Forêt Montmorency") +
        geom_density(alpha=.7) +
        scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_M_sub$temp))]) +
        theme_minimal()


# patch area for eastern townships
# # Stacked density chart
p1_ET <- ggplot(data=area_ET_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_ET_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p2_ET <- ggplot(data=area_ET_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_ET_sub$temp))]) +
            theme_minimal()
```

```{r p1, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=FALSE}
p1 <- ggarrange(p1_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p1_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p1_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p1, 
                top = text_grob("Patch area density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Count", color = "black", rot = 90))
```

```{r p2, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=FALSE}
p2 <- ggarrange(p2_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p2_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p2_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p2, 
                top = text_grob("Patch area density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Density", color = "black", rot = 90))
```

```{r line plot area, fig.align='center', out.width = "110%", fig.asp = .6, echo=FALSE, eval=FALSE}
# # line plot
# # # Function to plot 
area.linePlot <- function(df, ...){
    areaClass <- round(exp(seq(log(1), log(100), le = 4))) # Log sequence
    df$class <- 1
    for(i in seq_along(areaClass)){
        df$class[df$area >= areaClass[i]] <- i+1
    }
    df_agg <- aggregate(area ~ class + temp, data = df, "length")
    # Cols
    colo <- colorRampPalette(c("grey90", "steelblue4", 
                            "steelblue2", "blue4", 
                            "gold", "red1", "red4"))(length(areaClass)+1)
    plot(log(area) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == 1,], ylim = c(0,log(max(df_agg$area))), type = "b", lty=1, col = colo[1],
        ylab = "log(count)", xlab = "Temperature increase (°C)", ...)
    for(i in 1:length(areaClass)+1){
        lines(log(area) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == i,], col = colo[i], type = "b")
    }
    legend("topright", legend = c(paste0("< ", round(areaClass,1), "km2"), paste0("> ", round(areaClass[which.max(areaClass)],1), "km2")), col = colo, lty=1, title = "Patch area class", bty = "n")
}

par(mfrow=c(1,3), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
area.linePlot(area_QC_sub, main = "Québec")
area.linePlot(area_ET_sub, main = "EasternTownships")
area.linePlot(area_M_sub, main = "Forêt Montmorency")
```



## Interpatch distance

```{r distance subfigures, echo=FALSE, eval=FALSE}
# Interpatch distance for full QC
# # Stacked density chart
p3_QC <- ggplot(data=dist_QC_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(position="fill", adjust = 8) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_QC <- ggplot(data=dist_QC_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# Interpatch distance for foret montmorency
# # Stacked density chart
p3_M <- ggplot(data=dist_M_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Forêt Montmorency") +
            geom_density(position="fill", adjust = 8) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_M <- ggplot(data=dist_M_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Forêt Montmorency") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# Interpatch distance for Eastern townships
# # Stacked density chart
p3_ET <- ggplot(data=dist_ET_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_ET <- ggplot(data=dist_ET_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()
```

```{r p3, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=FALSE}
p3 <- ggarrange(p3_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p3_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p3_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p3, 
                top = text_grob("Interpatch distance density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Count", color = "black", rot = 90))
```

```{r p4, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE, eval=FALSE}
p4 <- ggarrange(p4_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p4_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p4_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p4, 
                top = text_grob("Interpatch distance density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Density", color = "black", rot = 90))
```

```{r line plot distance, fig.align='center', out.width = "100%", fig.asp = .6, echo=FALSE, eval=FALSE}
# # line plot
# # # Function to plot 
dist.linePlot <- function(df, ...){
    distClass <-round(exp(seq(log(1), log(6), le = 4))) # Log sequence
    df$class <- 1
    for(i in seq_along(distClass)){
        df$class[df$dist >= distClass[i]] <- i+1
    }
    df_agg <- aggregate(dist ~ class + temp, data = df, "length")
    # Cols
    colo <- colorRampPalette(c("grey90", "steelblue4", 
                            "steelblue2", "blue4", 
                            "gold", "red1", "red4"))(length(distClass)+1)
    plot(log(dist) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == 1,], ylim = c(0,log(max(df_agg$dist))), type = "b", lty=1, col = colo[1],
        ylab = "log(count)", xlab = "Temperature increase (°C)", ...)
    for(i in 1:length(distClass)+1){
        lines(log(dist) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == i,], col = colo[i], type = "b")
    }
    legend("topright", legend = c(paste0("< ", round(distClass,1), "km"), paste0("> ", round(distClass[which.max(distClass)],1), "km")), col = colo, lty=1, title = "Distance class", bty = "n")
}

par(mfrow=c(1,3), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
dist.linePlot(dist_QC_sub, main = "Québec")
dist.linePlot(dist_ET_sub, main = "EasternTownships")
dist.linePlot(dist_M_sub, main = "Forêt Montmorency")
```
