---
title: "SDM results"
author: "Victor Cameron"
date: "08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE)
```


```{r dependencies, echo=FALSE}
library(ggplot2)
library(hrbrthemes)
library(ggpubr)
```

```{r GRBI map, echo=FALSE}
if(!file.exists("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png")){
    source("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/map_GRBI.R")
    
    plot.map(projRaster_path = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/projections_GRBI.RDS", 
             extent = c(xmin = -75, xmax = -64, ymin = 45, ymax = 49.5), 
             file_name = "/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png")   
}
```

```{r extract metrics, echo=FALSE}
# Functions to extract metrics

# # Patch area
extract.patchArea <- function(metrics){
    area <- setNames(data.frame(matrix(ncol = 2, nrow = 0)), c("area", "temp"))
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        for(j in seq_along(metrics[[i]]$patchArea$patch)){
            area <- rbind(area, c(metrics[[i]]$patchArea$area[j], i*0.2-0.2))
        }
    }
    colnames(area) <- c("area", "temp")
    area$temp <- as.factor(area$temp)
    
    return(area)
}

# # Inter patch distance
extract.dist <- function(metrics){
    dist <- setNames(data.frame(matrix(ncol = 2, nrow = 0)), c("dist", "temp"))
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        dij <- metrics[[i]]$d_ij[lower.tri(metrics[[i]]$d_ij, diag = FALSE)]
        temp <- rep(i*0.2-0.2, length(dij))

        dist <- rbind(dist, data.frame(dij, temp))
    }
    colnames(dist) <- c("dist", "temp")
    dist$temp <- as.factor(dist$temp)
    
    return(dist)
}

# # Metapop capacity
extract.capacity <- function(metrics){
    capacity <- c()
    for(i in seq_along(metrics)){
        if(metrics[[i]]$n == 0) next
        capacity[i] <- metrics[[i]]$capacity
    }
    
    return(capacity)
}
```

```{r full distribution, echo=FALSE}
# 1 - Full distribution -----------------------------------


# Data
metrics_QC <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_QC.RDS")

# Extract metrics
area_QC <- extract.patchArea(metrics_QC)
area_QC_sub <- area_QC[area_QC$temp %in% seq(0,4,by=2),]

dist_QC <- extract.dist(metrics_QC)
dist_QC_sub <- dist_QC[dist_QC$temp %in% seq(0,4,by=2),]

cap_QC <- extract.capacity(metrics_QC)
```

```{r EasternTownships, echo=FALSE}
# 2 - EasternTownships ------------------------------------


# Data
metrics_ET <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_ET.RDS")

# Extract metrics
area_ET <- extract.patchArea(metrics_ET)
area_ET_sub <- area_ET[area_ET$temp %in% seq(0,4,by=2),]

dist_ET <- extract.dist(metrics_ET)
dist_ET_sub <- dist_ET[dist_ET$temp %in% seq(0,4,by=2),]

cap_ET <- extract.capacity(metrics_ET)
```

```{r forêt Montmorency, echo=FALSE}
# 3 -Forêt Montmorency ------------------------------


# Data
metrics_M <- readRDS("/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/metrics_M.RDS")

# Extract metrics
area_M <- extract.patchArea(metrics_M)
area_M_sub <- area_M[area_M$temp %in% seq(0,4,by=2),]

dist_M <- extract.dist(metrics_M)
dist_M_sub <- dist_M[dist_M$temp %in% seq(0,4,by=2),]

cap_M <- extract.capacity(metrics_M)
```

## Maps

<center>
![](/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/GRBI.gif)

![](/Users/victorcameron/Documents/Git/Metapop_ms/SDM/results/map_GRBI.png)
</center>

## Results panel

```{r 4 panel area, fig.align='center', out.width = "100%", fig.asp = .8, echo=FALSE}
library(dplyr)
# 1. Combine all data
area_dupl <- bind_rows(area_QC, area_M, area_ET, .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))
dist_dupl <- bind_rows(dist_QC, dist_M, dist_ET, .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))
capacity <- bind_rows(data.frame(capacity = cap_QC, temp = cc), data.frame(capacity = cap_M, temp = cc), data.frame(capacity = cap_ET, temp = cc[seq_along(cap_ET)]), .id = "id") %>%
               mutate(id=replace(id, id==1, "QC")) %>%
               mutate(id=replace(id, id==2, "M")) %>%
               mutate(id=replace(id, id==3, "ET"))

# Count patch number per region and temperature step
dat_total <- group_by(area_dupl, id, temp) %>%
           summarise(n = n())
# Plot number of patches by region and temperature warming step
coeff <- 40
cols <- c("blue4", "green4", "brown3")
p_total <- ggplot(dat_total, aes(x=temp, y=n, group=id, color=id)) +
           scale_color_manual(values=cols) +
           geom_line(data = subset(dat_total, id %in% c("QC","M"))) +
           geom_line(data=subset(dat_total, id=="ET"), aes(y=n*coeff)) +
           #scale_linetype_manual(values=c("solid", "twodash", "dotted")) +
           scale_x_discrete(name="Temperature warming (°C)", breaks=seq(0,4,0.5)) +
           scale_y_continuous(name="Number of patches \n(Québec & F. Montmorency)", sec.axis = sec_axis(~./coeff, name="Number of patches \n(Eastern Tornships)")) +
           labs(linetype = "Regions") +
           theme_classic() +
           theme(legend.position = c(.95, .95), legend.justification = c("right", "top")) 

p_cap <- group_by(capacity, id, temp) %>%
           ggplot(aes(x=temp, y=capacity, group=id, color=id)) +
           geom_line() +
           scale_color_manual(values=cols) +
           scale_x_continuous(name="Temperature warming (°C)", breaks=seq(0,4,0.5)) +
           scale_y_continuous(name = "Metapop capacity") +
           labs(linetype = "Regions") +
           theme_classic()

pArea_QC <- ggplot(data=area_dupl[area_dupl$id == "QC" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[3],3)) +
            ggtitle("Québec") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic()
pArea_M <- ggplot(data=area_dupl[area_dupl$id == "M" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[2],3)) +
            ggtitle("Forêt Montmorency") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic()
pArea_ET <- ggplot(data=area_dupl[area_dupl$id == "ET" & area_dupl$temp %in% c(0,2,4),], aes(x=log(area), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[1],3)) +
            ggtitle("Eastern Townships") +
            geom_density(aes(linetype=temp)) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-4,8,4), limits = c(-4,8)) +
            theme_classic()
pDist_QC <- ggplot(data=dist_dupl[dist_dupl$id == "QC" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[3],3)) +
            geom_density(aes(linetype=temp), adjust = 8) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()
pDist_M <- ggplot(data=dist_dupl[dist_dupl$id == "M" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[2],3)) +
            geom_density(aes(linetype=temp), adjust = 8) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()
pDist_ET <- ggplot(data=dist_dupl[dist_dupl$id == "ET" & dist_dupl$temp %in% c(0,2,4),], aes(x=log(dist), group=temp, color=temp)) +
            scale_color_manual(values=rep(cols[1],3)) +
            geom_density(aes(linetype=temp), adjust = 5) +
            scale_y_continuous(breaks=seq(0,0.6,0.2), limits = c(0,0.65)) +
            scale_x_continuous(breaks=seq(-6,2.5,4), limits = c(-6,2.5)) +
            theme_classic()

ggarrange(p_total, p_cap + rremove("legend"),
          ggarrange(pArea_QC + rremove("legend") + rremove("xlab"), pArea_M + rremove("legend") + rremove("y.text") + rremove("ylab"), pArea_ET + rremove("legend") + rremove("y.text") + rremove("ylab") + rremove("xlab"), ncol = 3, align = "h", widths = c(1.2, 1, 1)),
          ggarrange(pDist_QC + rremove("legend") + rremove("xlab"), pDist_M + rremove("legend") + rremove("y.text") + rremove("ylab"), pDist_ET + rremove("legend") + rremove("y.text") + rremove("ylab") + rremove("xlab"), ncol = 3, align = "h", widths = c(1.2, 1, 1)),
          nrow = 4, heights = c(1.5, 1.5, 1.2, 1))
```

## Metapop effect

Habitat availability vs. landscape connectivity (capacity)

```{r metapop effect, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE}

```


# Exploration of visualizations

## Patch area

```{r area subfigures, echo=FALSE}
# Patch area for full QC
# # Stacked density chart
p1_QC <- ggplot(data=area_QC_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p2_QC <- ggplot(data=area_QC_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# patch area for foret montmorency
# # Stacked density chart
p1_M <- ggplot(data=area_M_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
        ggtitle("Forêt Montmorency") +
        geom_density(position="fill", adjust = 3) +
        scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_M_sub$temp))]) +
        theme_minimal()
# # Multi density chart
p2_M <- ggplot(data=area_M_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
        ggtitle("Forêt Montmorency") +
        geom_density(alpha=.7) +
        scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_M_sub$temp))]) +
        theme_minimal()


# patch area for eastern townships
# # Stacked density chart
p1_ET <- ggplot(data=area_ET_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_ET_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p2_ET <- ggplot(data=area_ET_sub, aes(x=log(area), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_ET_sub$temp))]) +
            theme_minimal()
```

```{r p1, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE}
p1 <- ggarrange(p1_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p1_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p1_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p1, 
                top = text_grob("Patch area density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Count", color = "black", rot = 90))
```

```{r p2, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE}
p2 <- ggarrange(p2_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p2_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p2_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p2, 
                top = text_grob("Patch area density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Density", color = "black", rot = 90))
```

```{r line plot area, fig.align='center', out.width = "110%", fig.asp = .6, echo=FALSE}
# # line plot
# # # Function to plot 
area.linePlot <- function(df, ...){
    areaClass <- round(exp(seq(log(1), log(100), le = 4))) # Log sequence
    df$class <- 1
    for(i in seq_along(areaClass)){
        df$class[df$area >= areaClass[i]] <- i+1
    }
    df_agg <- aggregate(area ~ class + temp, data = df, "length")
    # Cols
    colo <- colorRampPalette(c("grey90", "steelblue4", 
                            "steelblue2", "blue4", 
                            "gold", "red1", "red4"))(length(areaClass)+1)
    plot(log(area) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == 1,], ylim = c(0,log(max(df_agg$area))), type = "b", lty=1, col = colo[1],
        ylab = "log(count)", xlab = "Temperature increase (°C)", ...)
    for(i in 1:length(areaClass)+1){
        lines(log(area) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == i,], col = colo[i], type = "b")
    }
    legend("topright", legend = c(paste0("< ", round(areaClass,1), "km2"), paste0("> ", round(areaClass[which.max(areaClass)],1), "km2")), col = colo, lty=1, title = "Patch area class", bty = "n")
}

par(mfrow=c(1,3), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
area.linePlot(area_QC_sub, main = "Québec")
area.linePlot(area_ET_sub, main = "EasternTownships")
area.linePlot(area_M_sub, main = "Forêt Montmorency")
```



## Interpatch distance

```{r distance subfigures, echo=FALSE}
# Interpatch distance for full QC
# # Stacked density chart
p3_QC <- ggplot(data=dist_QC_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(position="fill", adjust = 8) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_QC <- ggplot(data=dist_QC_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Québec") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# Interpatch distance for foret montmorency
# # Stacked density chart
p3_M <- ggplot(data=dist_M_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Forêt Montmorency") +
            geom_density(position="fill", adjust = 8) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_M <- ggplot(data=dist_M_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Forêt Montmorency") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()


# Interpatch distance for Eastern townships
# # Stacked density chart
p3_ET <- ggplot(data=dist_ET_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(position="fill", adjust = 3) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(dist_QC_sub$temp))]) +
            theme_minimal()

# # Multi density chart
p4_ET <- ggplot(data=dist_ET_sub, aes(x=log(dist), group=temp, fill=temp, after_stat(count))) +
            ggtitle("Eastern Townships") +
            geom_density(alpha=.7) +
            scale_fill_viridis_d(end = seq(0,1,le=6)[length(unique(area_QC_sub$temp))]) +
            theme_minimal()
```

```{r p3, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE}
p3 <- ggarrange(p3_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p3_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p3_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p3, 
                top = text_grob("Interpatch distance density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Count", color = "black", rot = 90))
```

```{r p4, fig.align='center', out.width = "100%", out.height = "75%", fig.asp = .6, echo=FALSE}
p4 <- ggarrange(p4_QC + rremove("ylab") + rremove("legend") + rremove("xlab"), 
                p4_ET + rremove("y.text") + rremove("ylab") + rremove("legend"), 
                p4_M + rremove("y.text") + rremove("ylab") + rremove("xlab"), 
          #labels = c("A", "B", "C"),
          ncol = 3, nrow = 1,
          widths = c(1, 0.9, 1.2), align = "h")
annotate_figure(p4, 
                top = text_grob("Interpatch distance density plots", color = "black", face = "bold", size = 14),
                left = text_grob("Density", color = "black", rot = 90))
```

```{r line plot distance, fig.align='center', out.width = "100%", fig.asp = .6, echo=FALSE}
# # line plot
# # # Function to plot 
dist.linePlot <- function(df, ...){
    distClass <-round(exp(seq(log(1), log(6), le = 4))) # Log sequence
    df$class <- 1
    for(i in seq_along(distClass)){
        df$class[df$dist >= distClass[i]] <- i+1
    }
    df_agg <- aggregate(dist ~ class + temp, data = df, "length")
    # Cols
    colo <- colorRampPalette(c("grey90", "steelblue4", 
                            "steelblue2", "blue4", 
                            "gold", "red1", "red4"))(length(distClass)+1)
    plot(log(dist) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == 1,], ylim = c(0,log(max(df_agg$dist))), type = "b", lty=1, col = colo[1],
        ylab = "log(count)", xlab = "Temperature increase (°C)", ...)
    for(i in 1:length(distClass)+1){
        lines(log(dist) ~ as.numeric(as.character(temp)), data = df_agg[df_agg$class == i,], col = colo[i], type = "b")
    }
    legend("topright", legend = c(paste0("< ", round(distClass,1), "km"), paste0("> ", round(distClass[which.max(distClass)],1), "km")), col = colo, lty=1, title = "Distance class", bty = "n")
}

par(mfrow=c(1,3), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
dist.linePlot(dist_QC_sub, main = "Québec")
dist.linePlot(dist_ET_sub, main = "EasternTownships")
dist.linePlot(dist_M_sub, main = "Forêt Montmorency")
```
